{% extends "base.html" %}


{% block xsrf %}<meta name="_xsrf" content="{{xsrf_token}}">{% end %}


{% block title %}{{poll['question']}}{% end %}


{% block container %}
    <div class="row">


        <div class="page-header">
            <h1>{{poll['question']}}</h1>
        </div>


        <div class="lead text-muted">

            By <a href="/users/{{poll['user_id']}}" title="Created by @{{poll['user_name']}}">@{{poll['user_name']}}</a>
            <a href="{{poll['post_url']}}" target="_blank" title="View on ADN">
                <span class='datetime' data-datetime="{{poll['created_at']}}">{{poll['created_at_human']}}</span></a>&nbsp;
            <span>{{poll['views']}} views</span>&nbsp;
            <a href="{{poll['post_url']}}" target="_blank" title="View on ADN">
                <span class="glyphicon glyphicon-link"></span></a>&nbsp;

            {% if current_user is not None %}
                {% module PollsStar(poll_id=poll['_id'], user_id=current_user['_id'], starred_by=poll['post_starred_by']) %}&nbsp;
                {% module PollsRepost(poll_id=poll['_id'], user_id=current_user['_id'], reposted_by=poll['post_reposted_by']) %}
            {% end %}

        </div>


        <div class="col-md-12">


            <div id="donutchart" style="height: 500px;" class="row">
            {% if poll['total_votes'] == 0 %}
                <p class="lead text-center" style="padding-top: 200px;">No one has cast a vote yet, be the first and make history!</p>
            {% end %}
            </div>


            <div class='row'>
                <form role="form" id="vote" data-poll-id="{{poll['_id']}}" class="col-md-10 col-md-offset-1">
                    {% raw xsrf_input %}

                    {% for option in poll['options'] %}
                    <div class="radio">
                        <label>
                            <input type="radio" name="option" id="option" value="{{option['_id']}}" tabindex=1>
                            {{option['display_text']}}
                        </label>
                    </div>
                    {% end %}

                    <br/>

                    {% if current_user is None %}
                        
                        <div class='pull-right'>
                            <a href='/auth/redirect?redirect={{escape(redirect)}}' class="btn btn-default btn-lg">Sign in and be a voting hero</a>
                        </div>

                    {% else %}
                        
                        {% if user_has_voted %}
                            <div class="alert alert-success has-not-voted">
                        {% else %}
                            <div class="alert alert-success has-voted hidden">
                        {% end %}
                                <strong>Nice vote!</strong>
                                Help out <a href="/users/{{poll['user_id']}}">@{{poll['user_name']}}</a> and give their poll a
                                {% module PollsStar(poll_id=poll['_id'], user_id=current_user['_id'], starred_by=poll['post_starred_by']) %}
                                and&nbsp;
                                {% module PollsRepost(poll_id=poll['_id'], user_id=current_user['_id'], reposted_by=poll['post_reposted_by']) %}
                                or check out <a href="/polls/{{poll['_id']}}/next">another poll</a>.
                            </div>

                        {% if not user_has_voted %}
                            <div class="has-not-voted">
                                <button type="submit" id="post-vote" class="btn btn-default btn-lg pull-right btn-danger" disabled="disabled" tabindex=2>
                                    <span class="glyphicon glyphicon-check"></span>
                                     Vote and post to ADN
                                </button>
                            </div>
                        {% end %}

                    {% end %}
                </form>
                <br/>
            </div>


            {% if poll['total_votes'] > 3 %}
                <div class='row'>
                    <div class='col-md-10 col-md-offset-1'>
                        <br/>
                        <h4>{{poll['total_votes']}} people with opinions</h4>
                        <div>
                            {% for vote in poll['votes'][:100] %}
                            <a href="/users/{{vote['user_id']}}">
                                <img class="img-rounded" src="{{vote['user_avatar']}}?h=114&amp;w=114" title="@{{vote['user_name']}}" width="57" height="57" style="margin-bottom: 5px;" alt="@{{vote['user_name']}}'s avatar"/>
                            </a>
                            {% end %}
                        </div>
                        <br/>
                    </div>
                </div>
            {% end %}


            <div class='row'>
                <div class='col-md-10 col-md-offset-1'>
                    <br/>
                    <h4>Will your friends agree with you?</h4>
                    <form role="form" id="post" data-poll-id="{{poll['_id']}}" >
                        {% raw xsrf_input %}

                        <textarea class="form-control" rows="5" id="post-text" tabindex=3>{{post_text}}</textarea>
                        
                        <br/>
                        
                        {% if current_user is not None %}
                        <button type="submit" id="post-post" class="btn btn-default btn-lg pull-right btn-danger" tabindex=4>
                            <span class="glyphicon glyphicon-share"></span>
                             Post to ADN
                        </button>
                        
                        {% else %}
                        <div class="pull-right">
                            <a href='/auth/redirect?redirect={{escape(redirect)}}' class="btn btn-default btn-lg">Sign in to share like a BOSS</a>
                        </div>
                        {% end %}

                    </form>
                    <br/>
                </div>
            </div>
        </div>
    </div>
{% end %}


{% block scripts %}
<script>
    var data, chart;
    var pollId = "{{poll['_id']}}";
    var pollOptions = {% raw json_encode(options_object) %};
    var chartElem = document.getElementById('donutchart');
    var votes = {{poll['total_votes']}};

    if (votes > 0) {
        google.setOnLoadCallback(init);
    }


    function init() {
        data = new google.visualization.DataTable();
        data.addColumn('string', 'Option');
        data.addColumn('number', 'Votes');
        chart = new google.visualization.PieChart(chartElem);
        setZeroPollOptions(data, pollOptions);
        drawChart(chart, data);
        setPollOptions(data, pollOptions);
        drawChart(chart, data);

    }


    function setZeroPollOptions(data, options) {
        var index = 0;
        for (id in options) {
            data.addRow([options[id]['text'], 0]);
            options[id]['index'] = index;
            index++;
        }
    }


    function setPollOptions(data, options) {
        for (id in options) {
            data.setValue(options[id]['index'], 1, options[id]['votes']);
        }
    }


    function incrementVote(chart, data, option_id) {
        pollOptions[option_id]['votes'] += 1;
        data.setValue(pollOptions[option_id]['index'], 1, pollOptions[option_id]['votes']);
        drawChart(chart, data);
    }


    function drawChart(chart, data) {
        var chart_options = {
            pieHole: 0.3,
            animation: {
                duration: 200,
                easing: 'out'
            }
        };
        chart.draw(data, chart_options);
    }


    function postVote(event) {
        var option_id = $('#vote [name="option"]:checked').prop('value');
        var _xsrf = $('#vote [name="_xsrf"]').prop('value');
        if (votes == 0) {
            init();
        }

        incrementVote(chart, data, option_id);
        if (!option_id) {
            alert('You must select a value');
            return false;
        }

        $.ajax({
            type: "POST",
            url: "/polls/" + pollId + "/votes",
            data: { option_id: option_id, _xsrf: _xsrf },
            success: voteSuccess,
            error: function(errMsg) {
                console.log('ERROR', errMsg);
                alert('Oooops...something went wrong.');
            }
        });
        event.preventDefault()
    }

    function voteSuccess(data) {
        $('.has-not-voted').slideUp();
        $('.has-voted').hide().removeClass('hidden').slideDown();
    }


    function postPost(event) {
        var text = $('#post textarea').prop('value');
        var _xsrf = $('#post [name="_xsrf"]').prop('value');

        if (!text) {
            alert('There must be some text to post...');
            return false;
        }

        $.ajax({
            type: "POST",
            url: "/posts",
            data: { text: text, _xsrf: _xsrf },
            success: function(data){
                alert('Nobody posts like you, and I mean nobody!')
            },
            error: function(errMsg) {
                console.log('ERROR', errMsg);
                alert('Oooops...something went wrong.');
            }
        });
        event.preventDefault()
    }


    function enableVoteBtn() {
        $('#post-vote').removeAttr('disabled');
    }


    $(function() {
        $('#post-vote').on('click', postVote);
        $('#post-vote').on('submit', postVote);
        $('#post-post').on('click', postPost);
        $('#post-post').on('submit', postPost);
        $('#vote input').on('focus', enableVoteBtn);
        $('#vote input').on('click', enableVoteBtn);
    });

</script>
{% end %}
