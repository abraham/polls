{% autoescape xhtml_escape %}
{% extends "base.html" %}


{% block title %}{{title}}{% end %}


{% block container %}
<div class="">


    <div class="page-header">
        <h1>
            {{question}}
            <small class="text-muted">
                by @<a href="/users/{{owner_id}}">{{owner_username}}</a>
                {% if post_url %}
                <a href="{{post_url}}" target="_blank">
                    <span class='datetime' data-datetime="{{created_at}}">{{created_at}}</span>
                </a>
                {% else %}
                <span class='datetime' data-datetime="{{created_at}}">{{created_at}}</span>
                {% end %}
            </small>
        </h1>
    </div>


    <div id="donutchart" style="width: 940px; height: 500px;">
    {% if total_votes == 0 %}
        <p class="lead" style="padding-top: 200px;">No one has cast a vote yet, be the first and make history!</p>
    {% end %}
    </div>


    <div class='col-md-10'>
        <form role="form" id="vote" data-poll-id="{{poll_id}}">
            {% raw xsrf_input %}

            {% for option in options %}
            <div class="radio">
                <label>
                    <input type="radio" name="option" id="option" value="{{option['_id']}}" tabindex=1>
                    {{option['display_text']}}
                </label>
            </div>
            {% end %}

            <br/>

            {% if user_has_voted %}
            <p>
                <strong>You already voted like a champ!</strong>
                Why not <a href="/polls/{{poll_id}}/next">try another poll?</a>
            </p>

            {% elif user_is_authed and post_id %}
            <button type="submit" id="post-vote" class="btn btn-default btn-lg pull-right btn-danger" disabled="disabled" tabindex=2>
                <span class="glyphicon glyphicon-check"></span>
                 Vote and post to ADN
            </button>

            {% elif user_is_authed %}
            <button type="submit" id="post-vote" class="btn btn-default btn-lg pull-right" disabled="disabled" tabindex=2>
                <span class="glyphicon glyphicon-check"></span>
                 Vote
            </button>

            {% else %}
            <h3>
                <a href='/auth/redirect?redirect={{escape(redirect)}}' class="">Sign in and be a voting hero</a>
            </h3>

            {% end %}

        </form>
        <br/>
    </div>


    {% if total_votes > 5 %}
    <div class='col-md-10'>
        <br/>
        <h4>{{total_votes}} people with opinions</h4>
        <div>
            {% for vote in votes[:100] %}
            <a href="/users/{{vote['user_id']}}">
                <img class="img-rounded" src="{{vote['user_avatar']}}?h=114&w=114" title="@{{vote['user_name']}}" width="57px" height="57px" style="margin-bottom: 5px;"/>
            </a>
            {% end %}
        </div>
        <br/>
    </div>
    {% end %}


    <div class='col-md-10'>
        <br/>
        <h4>Will your friends agree with you?</h4>
        <form role="form" id="post" data-poll-id="{{poll_id}}">
            {% raw xsrf_input %}

            <textarea class="form-control" rows="5" id="post-text" tabindex=3>{{post_text}}</textarea>
            
            <br/>
            
            {% if user_is_authed %}
            <button type="submit" id="post-post" class="btn btn-default btn-lg pull-right btn-danger" tabindex=4>
                <span class="glyphicon glyphicon-share"></span>
                 Post to ADN
            </button>
            
            {% else %}
            <h3>
                <a href='/auth/redirect?redirect={{escape(redirect)}}' class="">Sign in to share like a BOSS</a>
            </h3>
            {% end %}

        </form>
        <br/>
    </div>
</div>
{% end %}


{% block scripts %}
<script>

    var poll_id = "{{poll_id}}";
    google.load("visualization", "1", {packages: ["corechart"]});
    {% if total_votes > 0 %}
    google.setOnLoadCallback(drawChart);
    {% end %}



    function drawChart() {
        var poll_options = {% raw json_encode(options_array) %};
        var data = google.visualization.arrayToDataTable(poll_options);

        var options = {
            pieHole: 0.3
        };

        var elem = document.getElementById('donutchart');
        if (elem) {
            var chart = new google.visualization.PieChart(elem);
            chart.draw(data, options);
        }
    }


    function postVote(event) {
        var option_id = $('#vote [name="option"]:checked').prop('value');
        var _xsrf = $('#vote [name="_xsrf"]').prop('value');
        if (!option_id) {
            alert('You must select a value');
            return false;
        }
        $.ajax({
            type: "POST",
            url: "/polls/" + poll_id + "/votes",
            data: { option_id: option_id, _xsrf: _xsrf },
            success: function(data){
                $('#post-vote').slideUp(function() {
                    $('#vote').append('<p>Nice vote! I bet your momma would be proud.</p>');
                });
            },
            error: function(errMsg) {
                console.log('ERROR', errMsg);
                alert('Oooops...something went wrong.');
            }
        });
        event.preventDefault()
    }


    function postPost(event) {
        var text = $('#post textarea').prop('value');
        var _xsrf = $('#post [name="_xsrf"]').prop('value');
        if (!text) {
            alert('There must be some text to post...');
            return false;
        }
        $.ajax({
            type: "POST",
            url: "/posts",
            data: { text: text, _xsrf: _xsrf },
            success: function(data){
                alert('Nobody posts like you, and I mean nobody!')
            },
            error: function(errMsg) {
                console.log('ERROR', errMsg);
                alert('Oooops...something went wrong.');
            }
        });
        event.preventDefault()
    }


    function enableVoteBtn() {
        $('#post-vote').removeAttr('disabled');
    }


$(function() {
    $('#post-vote').on('click', postVote);
    $('#post-vote').on('submit', postVote);
    $('#post-post').on('click', postPost);
    $('#post-post').on('submit', postPost);
    $('#vote input').on('focus', enableVoteBtn);
    $('#vote input').on('click', enableVoteBtn);
});

</script>
{% end %}
